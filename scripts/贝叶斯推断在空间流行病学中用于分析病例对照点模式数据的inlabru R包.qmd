---
title: "Untitled"
format: html
---

# 贝叶斯推断在空间流行病学中用于分析病例对照点模式数据的inlabru R包

## 摘要

**背景与目的**：在空间流行病学中，分析病例对照点模式数据是一个重要的问题。通常会将病例的空间分布与一组对照的空间分布进行比较，以评估空间风险的变化，并检测风险因素以及对潜在污染源的暴露情况，这通常使用空间回归模型来实现。

**方法**：使用对数高斯考克斯模型（log-Gaussian Cox models）来估计病例和对照点模式的强度，以便纳入固定效应和空间随机效应。通过集成嵌套拉普拉斯近似（INLA）方法使用inlabru R包进行贝叶斯推断。通过将潜在风险因素作为固定效应纳入模型来评估它们的影响，同时将残余空间变化视为具有Matérn协方差的高斯过程。此外，还使用不同的平滑项来模拟对污染源的暴露情况。

**结果**：所提出的方法已应用于Chorley-Ribble数据集，该数据集记录了英国兰开夏郡（England, United Kingdom）的肺癌和喉癌病例的位置以及一个废弃旧焚化炉的位置。以肺癌病例的位置作为对照，估计了两种类型病例的空间变化，并评估了焚化炉附近的喉癌病例增加情况。结果与文献中的发现相似。

**结论**：本文介绍了一个在流行病学框架内进行贝叶斯分析的多变量病例对照点模式的框架。使用inlabru R包可以轻松拟合评估空间变化以及风险因素和污染源影响的模型。

## 关键词

流行病学、inlabru、多变量点模式、INLA、空间统计、SPDE

## 1 引言

在过去的几十年中，空间统计已成为流行病学家和公共卫生科学家的重要工具。将病例的地理位置纳入研究，使研究人员能够识别研究区域内的疾病模式。此外，考虑额外的信息有助于评估风险因素对疾病模式的影响。整合来自不同来源的所有可用信息将使研究人员能够构建更合适的模型，以研究疾病的空间变化和相关风险因素。最近对空间流行病学统计方法的综述可在[1](#fn:1)中找到。

在许多情况下，不同事件（通常为病例和对照）的实际位置是已知的，而流行病学研究的主要目的是估计研究区域内的空间模式。在这种情况下，应考虑点模式分析[2](#fn:2)。

从统计学角度来看，当事件（点）可以被分类为不同的组时，产生的结构就是多变量（或标记）点模式。在空间流行病学中最常见的例子是比较不同疾病的病例或特定疾病的不同类型病例与一组对照在共同研究区域内的分析。例如，[5](#fn:5)研究了英国康沃尔（Cornwall）不同菌株牛结核病例的空间变化。

点过程（即生成点模式的潜在机制）通常是由分析流行病学数据的动机而发展起来的[6](#fn:6)，并且有几位作者表明考克斯过程[7](#fn:7)为建模受环境驱动的点过程提供了一个合适的框架[8](#fn:8)。

在病例对照研究中使用对数高斯考克斯过程对多变量点模式进行分析已在不同方式中进行了探索。本文将重点关注基于贝叶斯推断的方法。[9](#fn:9)使用马尔可夫链蒙特卡洛（MCMC）方法[11](#fn:11)在贝叶斯框架中展示了对数高斯考克斯过程的四种不同应用。作为替代，[12](#fn:12)描述了一个使用集成嵌套拉普拉斯近似[13](#fn:13)分析点模式的工具箱。此外，[14](#fn:14)提出了一种新的且计算方便的方法，通过近似似然函数来使用连续指定的高斯随机场进行对数高斯考克斯过程的推断。最近，[15](#fn:15)展示了使用INLA分析多变量点模式的一些高级特性。

关于多变量点模式分析的其他方法，[16](#fn:16)提出了一个新颖的框架，在该框架中，所有模式共享一个空间分量，并且为每个点过程考虑一个特定的空间分量。[17](#fn:17)和[18](#fn:18)研究了一组对照和三种不同类型癌症病例的空间变化，以便将对照的空间变化作为癌症病例空间变化的基线，以评估空间风险变化以及对不同潜在污染源的暴露情况。

本文的主要目的是介绍如何在流行病学背景下使用空间模型和贝叶斯推断分析点模式的详细过程和软件。为此，将使用inlabru R包[19](#fn:19)，原因有二。首先，它提供了一个简单且友好的编码环境。其次，它依赖于INLA方法和R-INLA R包，利用最近的方法论发展高效估计对数高斯考克斯模型[20](#fn:20)。因此，不擅长编程的研究人员将能够利用友好的软件环境，受益于最近的统计发展，分析他们研究中的数据。

本文的结构如下。第2节介绍了在流行病学框架内拟合多变量点模式的空间回归模型的主要方法。接下来，第3节描述了模型拟合。在第4节中，使用所提出的方法和软件对Chorley-Ribble数据集[21](#fn:21)进行了分析。最后，在第5节中提供了讨论和一些总结性评论。

## 2 多变量点模式分析

给定一个有界的研究区域$(D \subseteq \mathbb{R}^{2}\$，点模式是$D$中的一组点，即$\{x_{i}\}_{i=1}^{n}$。这些点是点过程的实现，点过程可以被视为决定不同事件位置的随机过程。例如，在流行病学中，点模式的一个典型例子是患有特定疾病的人的居住位置。

多变量点模式数据集包含不同类别或组别的事件位置。除了不同事件位置的坐标和确定每个事件所属点模式的标记外，这些数据集中可能还包含额外的信息，例如环境或社会经济因素。这些额外信息的存在影响模型的定义。

最简单的点过程模型是均匀泊松点过程[2](#fn:2)。该点过程具有两个基本特性：a) 有界区域内点的数量遵循泊松分布，其均值等于常数$\lambda$（称为强度）与研究区域面积的乘积，以及b) 属于不同不相交区域的点的独立性。参数$\lambda$表示点过程的强度，它代表单位面积内的平均点数。如果假设$\lambda$不是常数，则得到的点过程称为非均匀泊松过程。在这种情况下，强度取决于位置$x$，记作$\lambda(x)$。值得注意的是，建模这种非恒定强度的一个方便方法是对数高斯考克斯过程[7](#fn:7)，如下所述。

关于建模点模式，考虑一组$P+1$个模式，其中有一组对照和$P$种不同疾病的病例模式。估计第$i$个点模式的强度$\lambda_{i}(x)$的方法是使用对数高斯考克斯过程定义强度的对数如下：

$$
\log(\lambda_{i}(x)) = \alpha + \ldots + S(x); \forall i=0,\ldots,P \, x \in D
$$

其中，$\alpha$是截距，“$\ldots$”表示一系列加性项（例如，固定效应和随机效应），而$S(x)$是空间随机效应，用于捕捉任何残余空间变化。注意，强度$\lambda_{0}(x)$代表对照组的强度。

### 2.1 建模空间变化

可以提出几种具有不同结构的情景来估计不同点模式的强度。为了简单起见，现在不包括任何协变量或其他项（除了空间项）。例如，可以建立一个基线空间模型，分别考虑每个点模式的强度：

$$
\log(\lambda_{i}(x)) = \alpha_{i} + S_{i}(x); \forall i=1,\ldots,P
$$

其中，$\alpha_{i}$是第$i$个点模式的截距，而$S_{i}(x)$是空间连续效应。尽管这种方法可以简单地估计每个点模式的空间变化，但它假设不同的点模式彼此独立（这相当于分别分析每个点模式）。因此，该模型没有考虑可能影响点模式的任何额外信息。因此，除非考虑更复杂的模型，否则只能在不同点模式之间进行简单的比较（这些比较不考虑每个点模式之间的相互作用）。因此，应该开发更复杂的情景来处理病例对照情景的分析。

本文中的所有空间随机效应都将使用具有零均值和Matérn协方差函数的高斯过程来定义。该函数定义了空间效应在任意两点$x_{k}$和$x_{l}$之间的协方差，其距离为$d_{k,l}$，如下所示：

$$
\text{Cov}(S(x_{k}), S(x_{l})) = \sigma^{2} \frac{2^{1-\nu}}{\Gamma(\nu)} \left( \kappa d_{k,l} \right)^{\nu} K_{\nu} \left( \kappa d_{k,l} \right)
$$

其中，$\sigma^{2}$是方差参数，$\nu$是正平滑参数，$\kappa$是正尺度参数，用于控制协方差随距离的衰减。$\Gamma(\cdot)$是伽马函数，而$K_{\nu}(\cdot)$是第二类修正贝塞尔函数。

需要注意的是，这种类型的空间随机效应可以使用INLA有效地拟合，如第3.1节所述。此外，将固定$\nu$的值[15](#fn:15)，并使用名义范围$r$而不是$\kappa$。名义范围定义为$\sqrt{8\nu}/\kappa$，它是相关性约为0.14的距离，即如果两个观测值之间的距离大于名义范围，则空间相关性将很小或可以忽略不计。

### 2.2 评估空间变化

在病例对照研究中进行多变量点模式分析时，建议联合建模病例和对照[6](#fn:6)。病例的强度反映了疾病风险的变化以及人口风险分布的变化。包括对照组使我们能够调整人口风险分布，并识别与疾病相关的风险因素。因此，在病例对照研究中，考虑估计病例和对照的强度并比较它们是合适的。

对照组将提供人口风险分布的基线，并且假设它们是非均匀泊松过程的一个实现，其强度为$\lambda_{0}(x)$[3](#fn:3)。病例将被视为具有相应强度的不同非均匀点过程的实现，这些强度可能与对照组的强度不同。当风险因素不影响病例的发生时，它们的空间模式将与对照组的空间模式非常相似。相反，如果病例的空间模式与对照组的空间模式不同，则可能是由于相关风险因素引起的差异。

按照[17](#fn:17)中的符号，一个方便的方法是建模对照组和$P$组病例的强度如下：

$$
\log(\lambda_{0}(x)) = \alpha_{0} + S_{0}(x)
$$

$$
\log(\lambda_{i}(x)) = \alpha_{i} + S_{0}(x) + S_{i}(x), \forall i=1,\ldots,P
$$

其中，$\alpha_{0}$和$\alpha_{i}$分别是对照组和第$i$组病例的截距。$S_{0}(x)$是所有点过程共享的空间效应，而$S_{i}(x)$是第$i$个点过程的特定空间效应。

为了比较不同空间模式的空间模式，[5](#fn:5)提出计算病例和对照估计强度的比率。在我们的例子中，如果在对数尺度上进行估计，则变为：

$$
\log\left(\frac{\lambda_{i}(x)}{\lambda_{0}(x)}\right) = \log(\lambda_{i}(x)) - \log(\lambda_{0}(x)) = (\alpha_{i} + S_{0}(x) + S_{i}(x)) - (\alpha_{0} + S_{0}(x)) = (\alpha_{i} - \alpha_{0}) + S_{i}(x)
$$

因此，比较每组病例和对照依赖于特定空间项$S_{i}(x)$。因此，这种结构允许我们通过研究病例特定空间效应的估计来调查每组病例与对照之间是否存在任何差异。

### 2.3 检测高风险区域

高风险区域是研究区域内病例数量高于根据对照分布预期的区域。在病例对照研究中，检测这些区域至关重要。按照前面的方法，共享空间效应$S_{0}(x)$考虑了人口风险分布的空间分布，而特定效应$S_{i}(x)$捕捉了每个病例组偏离一般空间趋势的情况。

如方程（1）所示，$\alpha_{i} - \alpha_{0}$是无风险的基线。病例的空间分布偏离这个基线将由特定空间效应$S_{i}(x)$捕捉（并且，可能还有当建模病例的对数强度的线性预测器时包含的其他项）。

具体来说，如果有任何因素影响病例的空间模式，特定效应应该能够捕捉到它。因此，绘制特定空间效应的后验均值图并分析其后验分布的95%置信区间，将有可能检测出研究区域内任何高风险区域。

### 2.4 分析风险因素的影响

如上所述，多变量点模式数据集可能包含有关可能需要考虑的变量的额外信息。前面的模型可以修改以包含作为协变量的额外因素：

$$
\log(\lambda_{0}(x)) = \alpha_{0} + S_{0}(x)
$$

$$
\log(\lambda_{i}(x)) = \alpha_{i} + S_{0}(x) + F_{i}(x), \forall i=1,\ldots,P
$$

其中，如前所述，$\lambda_{0}(x)$和$\lambda_{i}(x)$分别是对照组和第$i$组病例的强度，$\alpha_{0}$和$\alpha_{i}$是截距，而$S_{0}(x)$是共享空间效应。现在，$F_{i}(x)$对应于对疾病$i$的协变量效应，它可以以不同的方式指定。例如，$F_{i}(x)$可以作为协变量$z_{x}$的简单线性效应包含（即$F_{i}(x) = \beta z_{x}$），作为依赖于空间变化的协变量$z(x)$的线性项（即$F_{i}(x) = \beta z(x)$），或者作为一般平滑项（例如，到污染源的距离）。当有多个协变量可用时，例如社会经济或环境信息，可以使用$p$个不同的项将它们包含在内，例如$F_{i}^{(1)}(x) + \ldots + F_{i}^{(p)}(x)$。

当处理暴露于污染源（如工业设施、焚化炉等）的风险因素时，会出现一个特定案例。这些污染源中的每一个都可能增加其附近的病例数量。换句话说，病例的空间分布可能受到距离这些污染源的距离的影响。这种暴露效应可以按照以下不同方法进行建模。

[17](#fn:17)考虑了上述模型，并提出了三种不同的方法来使用到污染源的距离包含暴露效应。第一个选项是考虑距离的线性效应。或者，可以提出基于距离的平滑项。或者，对距离进行二阶随机游走将产生一个平滑的效应估计。最后，他们还将这种效应视为一维高斯过程，以便效应可以采用平滑形式。这个高斯过程将被建模为具有零均值和一维Matérn协方差函数定义的方差（即使用从给定点到污染源的距离）。

## 3 贝叶斯推断用于模型拟合

如所述，将使用贝叶斯推断来估计模型参数和其他感兴趣的量。在贝叶斯推断中，最终目标是获得模型参数的联合后验分布。特别是，将使用集成嵌套拉普拉斯近似方法[13](#fn:13)进行推断。INLA特别适合处理可以表示为潜在高斯马尔可夫随机场的模型，并且可以利用这些模型的特性来提高计算效率。

简而言之，INLA旨在通过使用数值积分和拉普拉斯近似来估计潜在效应和超参数的后验边际分布。因此，INLA不是基于成本高昂的采样方法，如马尔可夫链蒙特卡洛算法。[22](#fn:22)提供了该方法及其应用的简要概述，并详细描述了INLA算法。

一旦获得了后验边际分布，INLA就能够计算诸如后验均值、95%置信区间和其他感兴趣的量等汇总统计量。此外，INLA还可以计算几种模型评估和选择标准，这些标准在比较不同模型时非常有用。

### 3.1 强度的估计

在估计点模式的强度时，可以遵循不同的方法[4](#fn:4)。上述模型被定义为对数高斯考克斯过程，可以包含一些固定效应、协变量的平滑项以及一个或多个将被建模为具有零均值和Matérn协方差定义的高斯过程的平滑项。

通过将它们表示为随机偏微分方程（SPDE）的解来估计空间效应[20](#fn:20)。特别是，用于估计具有Matérn协方差的高斯过程的SPDE近似基于以弱形式求解随机偏微分方程[20](#fn:20)。这种方法允许将估计的空间效应$S(x)$表示为：

$$
S(x) = \sum_{k=1}^{m} \psi_{k}(x) w_{k}
$$

在这个表示中，$\psi_{k}(x)$是基函数，而$w_{k}$是高斯权重。索引$k$指的是覆盖研究区域的三角剖分（或网格）中的一个特定顶点。每个基函数$\psi_{k}(x)$在网格的三角形内是分段线性的，在顶点$k$处等于1，在所有其他顶点处等于0。这种稀疏表示在计算上是高效且实用的，适用于大规模空间数据分析。

SPDE方法特别具有优势，因为它将处理密集协方差矩阵的问题转化为涉及稀疏精度矩阵的问题。这是通过使用网格的有限元方法（FEM）来表示空间场实现的，使计算更加可行。在使用这种方法报告结果时，名义方差和名义范围用于总结空间效应$S_{i}(x)$的估计值，对于$i=0,\ldots,P$。

关于更多细节，读者可以参考[15](#fn:15)、[23](#fn:23)和[24](#fn:24)。值得一提的是，我们需要正确构建SPDE近似所使用的网格，因为其选择可能会影响估计的数值精度。关于这一点的建议可以在[15](#fn:15)的第2章中找到。

### 3.2 先验分布的选择

先验分布是贝叶斯分析的一个重要组成部分，必须适当选择。R-INLA和inlabru的实现通常依赖于一些默认的先验选择，因此如果未指定先验分布，这些函数将自动应用默认选项。然而，这些默认先验可能并不适用于每个上下文。

R-INLA提供了广泛的选择，并且该包提供了几种定义超参数不同先验分布的方法。读者可以参考[24](#fn:24)的第5章和[15](#fn:15)，其中详细介绍了如何在INLA中定义先验。

关于分析中选择的先验，对于截距和固定效应的系数将使用默认先验。对于截距，使用零均值和零精度的非适当高斯先验。对于固定效应的系数，默认先验是零均值和1000精度的高斯分布。

在分析对数高斯考克斯过程时，空间超参数的先验选择也必须谨慎进行。对于空间效应的参数，将使用惩罚复杂性先验[25](#fn:25)。构建这些先验分布的想法遵循了节俭原则，通过惩罚与基线模型的距离。此外，它们是使用直观的概率陈述设置的。

尽管很难为本文讨论的模型提供关于先验选择的一般性建议，但希望对空间效应的名义范围和名义方差的先验分布参数的选择提供一些指导。[26](#fn:26)详细描述了如何在正则网格中分析对数高斯考克斯过程时为超参数选择先验分布。

非正式地，范围代表数据不再相关的距离限制。因此，设置先验的一个合理方法是选择研究区域内的最大距离（“直径”）的一半，大约，并指定范围大于此距离的概率较低，例如：

$$
P(r < 0.5 \cdot \max_{d}) = 0.99
$$

在标准差的情况下，我们的建议遵循[26](#fn:26)中的想法。具体来说，考虑了强度变化的上限$U_{\alpha}$：

$$
P(\sigma > U_{\alpha}) = 0.01
$$

这个上限的值将取决于每个问题，因为它衡量了强度在研究区域内的变化。$U_{\alpha}$的值可以通过考虑我们期望强度如何在研究区域内变化来设置。

### 3.3 软件

INLA方法在R-INLA包中实现，而inlabru是一个旨在使用INLA促进空间和时空建模的R包。它特别适用于贝叶斯推断高度参数化的模型，为拟合可能具有空间或时间结构的数据的模型提供了一个灵活的框架。它提供了一个用户友好的界面，用于使用熟悉的公式语法定义复杂的模型，使其比直接使用R-INLA更容易拟合模型。inlabru特别适用于点过程模型，并且与用于空间数据处理和可视化的其他R包集成良好。

在开发示例时，使用了sf[27](#fn:27)和terra[28](#fn:28) R包进行数据管理和可视化。此外，本文中的地图是使用R包ggplot2[29](#fn:29)和tmap[30](#fn:30)创建的。

## 4 示例

在本节中，将使用inlabru（版本2.12.0）和INLA（版本24.06.27）R包对一个多变量点模式数据集进行分析，以说明本文介绍的方法。所选数据集是Southlancs数据集，可在splancs R包[31](#fn:31)中找到。该数据集包含喉癌和肺癌病例的位置以及一个1984年关闭的废弃焚化炉的位置。所有病例均位于英国兰开夏郡的Chorley-Ribble地区。坐标以公里为单位，分辨率为100米（0.1公里）。选择该数据集的原因是它已被广泛分析[32](#fn:32)，并且任何人都可以访问，以便严格重现此示例。

接下来，将逐步进行该数据集的多变量分析，考虑将肺癌病例作为基线点模式，通常假定为对照组[21](#fn:21)。算法1展示了使用inlabru进行点模式数据分析的不同步骤。

**算法1** 使用inlabru分析点模式数据

1. 加载所需数据。
2. 构建网格。
3. 构建SPDE基函数。
4. 定义模型似然和组件。
5. 拟合模型。
6. 提取结果。
7. 显示和分析结果。

图1的左侧显示了兰开夏郡Chorley和South Ribble卫生局（英国）的肺癌病例（蓝色）、喉癌病例（紫色）、废弃焚化炉的位置（红色）以及研究区域的边界。

![图1](extracted/6292539/Plots/Figure1Left.png)

**图1**：兰开夏郡Chorley和South Ribble卫生局的肺癌和喉癌病例位置（左）以及SPDE方法使用的网格（右）。

### 4.1 估计空间变化

示例从分别对每个点模式进行单变量分析开始。因此，单变量分析的结果可以被视为基线结果，以便与更复杂模型的结果进行比较。

图1的右侧显示了用于分析southlancs数据的网格。构建网格将是拟合SPDE模型的第一步。网格设计可以影响结果的计算，因此，必须遵循一些基本概念进行构建。首先，三角形的大小和形状应尽可能规则，以便在整个区域内保持恒定的估计。避免边界效应也很重要，方法是在距离研究区域边界一定距离处设置网格的外边界[35](#fn:35)。[15](#fn:15)提供了一些在处理网格定义时需要考虑的相关细节。此外，网格应足够小，以便能够捕捉短距离效应以及协变量效应的空间变化。

推荐使用fm_mesh_2d_inla()函数来创建网格。例如，这里展示了在本研究中使用的网格构建代码：

```{r}
mesh <- fm_mesh_2d_inla(
  boundary = list(bdy_sf, NULL),
  cutoff = 0.4,
  max.edge = c(0.6, 1.2),
  min.angle = 27,
  offset = c(0.5, 2),
  n = c(16, 16)
)
```

`boundary`参数用于指定内边界和/或外边界；这里，`bdy_sf`是存储研究区域边界的对象。`cutoff`参数允许你指定两个节点（三角形顶点）之间的最小距离。`max.edge`和`min.angle`参数分别设置三角形边的最大长度和最小内角。`n`参数指定初始节点的数量，而`offset`参数确定外边界的距离。

此外，还可以通过调用meshbuilder()函数来构建网格，该函数打开一个Shiny界面[36](#fn:36)，允许在交互式环境中为fm_mesh_2d_inla()函数的参数选择合适的值。这可以非常方便地找到参数的最佳值。

一旦定义了网格，就应该构建基函数，以便使用SPDE方法估计空间效应。同时，将指定空间超参数（范围和名义标准差）的先验分布。在指定先验分布时，可以考虑几种选项。在本分析中，将使用inla.spde2.pcmatern()函数设置PC先验[25](#fn:25)。具体来说，将为名义范围（$r$）和名义标准差（$\sigma$）设置以下先验分布：

$$
P(r < 10) = 0.99
$$

$$
P(\sigma > 1) = 0.01
$$

注意，$\sigma$是对数尺度上高斯随机效应的标准差。因此，大于1的值将意味着强度的非常大变化，这对于当前分析来说是不合理的。

这些先验分布是专门为本分析设置的。还进行了敏感性分析（作为补充材料提供），以评估名义标准差的先验选择的影响。关于PC先验参数选择的一些评论已在第3.2节[3.2 Prior distribution choice](https://arxiv.org/html/2503.14954v1#S3.SS2 "3.2 Prior distribution choice ‚Ä£ 3 Bayesian inference for model fitting ‚Ä£ Bayesian inference for case-control point pattern data in spatial epidemiology with the inlabru R package")中讨论过。这些值是根据应用于该数据集的标准选择的。这里可以看到相关的代码行：

```{r}
pcmatern <- inla.spde2.pcmatern(
  mesh = mesh, alpha = 2,
  prior.range = c(10, 0.99),
  prior.sigma = c(1, 0.01)
)
```

注意，参数`alpha = 2`用于在Matérn协方差的定义中将参数$\nu$设置为1（因为$\nu$等于`alpha`减去维度除以2[20](#fn:20)）。

一旦定义了估计空间效应的设置，就可以定义模型组件以估计不同的强度。首先，定义单变量模型如下：

$$
\log(\lambda_{i}(x)) = \alpha_{i} + S_{i}(x); \forall i=0,1
$$

此模型使用R公式定义如下：

```{r}
cmp <- geometry ~
   Intercept(1) + spatialspde(geometry, model = pcmatern)
```

左侧的`geometry`项表示点的空间坐标。模型的截距（$\alpha_{i}$）由`Intercept(1)`表示，然后空间效应（$S_{i}(x)$）由最后一个组件`spatialspde(geometry, model = pcmatern)`表示，它接受两个参数：点的坐标（`geometry`）和SPDE模型的规范（变量`pcmatern`，如上定义）。

尽管在前面的代码行中空间项被称为`spatialspde`，但这个特定名称不是强制的。可以使用任何名称，只要在整个代码中一致使用即可。然而，括号内的结构必须保持一致。第一个参数指定变化的空间场（在我们的例子中，是点模式的坐标），第二个参数`model`定义相关函数（在我们的例子中，是前面定义的SPDE模型）。

在这一点上，可以使用inlabru包的`lgcp()`函数拟合模型，如下所示：

```{r}
fit.lun <- lgcp(
  components = cmp,
  data = sl.lun,
  domain = list(geometry = mesh),
  samplers = bdy_sf
)
```

注意，此模型使用了包含肺癌病例位置的数据集`sl.lun`。可以通过相应地替换`data`参数的值，为喉癌病例拟合类似的模型。

拟合模型后，可以显示强度的估计值。图2显示了分别估计的肺癌（左）和喉癌（右）病例强度的估计值（后验均值）。这些结果是通过分别对每组癌症病例进行单变量分析获得的。此外，在比较估计值时需要考虑比例尺的差异，因为有58例喉癌病例和978例肺癌病例。

![图2](extracted/6292539/Plots/Lung_intensity.png)

**图2**：分别估计的肺癌病例（左）和喉癌病例（右）的强度估计值。注意比例尺的差异。

### 4.2 比较病例和对照

尽管单变量分析是一个合理的起点，但病例对照研究需要通过更复杂的方法进行更深入的分析。按照之前的研究[21](#fn:21)，将肺癌病例视为对照组进行分析。这将允许我们比较病例和对照的空间分布，如第2.2节[2.2 Assessing spatial variation](https://arxiv.org/html/2503.14954v1#S2.SS2 "2.2 Assessing spatial variation ‚Ä£ 2 Multivariate point pattern analysis ‚Ä£ Bayesian inference for case-control point pattern data in spatial epidemiology with the inlabru R package")所述，并在第2.3节[2.3 Detection of high risk areas](https://arxiv.org/html/2503.14954v1#S2.SS3 "2.3 Detection of high risk areas ‚Ä£ 2 Multivariate point pattern analysis ‚Ä£ Bayesian inference for case-control point pattern data in spatial epidemiology with the inlabru R package")中检测研究区域内的高风险区域。从现在开始，对照组将指肺癌病例，而病例组将指喉癌病例。

首先，考虑一个仅包含在两组之间共享的空间项$S_{0}(x)$的基线模型，该模型将捕获两种点模式的强度的空间变化，如下所示：

$$
\log(\lambda_{0}(x)) = \alpha_{0} + S_{0}(x)
$$

$$
\log(\lambda_{1}(x)) = \alpha_{1} + S_{0}(x) \quad \forall x \in D
$$

其中，$\lambda_{0}(x)$和$\lambda_{1}(x)$分别是对照组和病例组的强度。此外，$\alpha_{0}$和$\alpha_{1}$分别代表对照组和病例组的截距。

接下来，将添加一个特定于病例的空间效应$S_{1}(x)$，如第2.2节所述。这将导致一个具有两个似然的模型，每个点模式一个。注意，$S_{0}(x)$项将在两个似然之间共享。

$$
\log(\lambda_{0}(x)) = \alpha_{0} + S_{0}(x)
$$

$$
\log(\lambda_{1}(x)) = \alpha_{1} + S_{0}(x) + S_{1}(x) \quad \forall x \in D
$$

这两个空间效应将使用与单变量模型中相同的网格和先验进行拟合，但每个空间项现在将估计不同的参数集。

接下来，需要指定模型组件。在这种情况下，为每个点模式设置一个截距（分别命名为`Inter.con(1)`和`Inter.lar(1)`），并添加共享空间效应$S_{0}(x)$（作为组件`sharedspde`）。添加`-1`项是为了从模型中移除默认的截距。定义代码如下：

```{r}
cmp <- geometry ~ -1 + Inter.con(1) + Inter.lar(1) +
  sharedspde(geometry, model = pcmatern)
```

由于考虑了两个似然，因此使用`like()`函数和上面定义的组件来指定它们，如下所示：

```{r}
# 对照组（肺癌）的似然
con.lik <- like(
  family = "cp",
  formula = geometry ~ Inter.con + sharedspde,
  samplers = bdy_sf,
  data = sl.lun,
  domain = list(geometry = mesh)
)

# 病例组（喉癌）的似然
lar.lik <- like(
  family = "cp",
  formula = geometry ~ Inter.lar + sharedspde,
  samplers = bdy_sf,
  data = sl.lar,
  domain = list(geometry = mesh)
)
```

这里，参数`family = "cp"`表明我们正在调整一个考克斯过程，然后指定每个似然的结构。定义了似然之后，可以使用`bru()`函数拟合模型：

```{r}
fit <- bru(cmp, con.lik, lar.lik)
```

如前文所述，拟合模型后，我们可以展示和总结模型中的任何组件，例如强度或空间效应。

要评估病例和对照强度之间的差异，模型将包括喉癌的特定空间效应$S_{1}(x)$。此外，空间效应$S_{1}(x)$将潜在地显示出高风险区域。

组件和似然定义是唯一需要修改的地方，通过添加特定的空间项，该空间项在代码中被命名为`larspde`：

```{r}
cmp <- geometry ~ -1 + Inter.con(1) + Inter.lar(1) +
  sharedspde(geometry, model = pcmatern) +
  larspde(geometry, model = pcmatern)
```

注意，组件`larspde`是一个空间随机效应，其定义方式与另一个空间效应类似，但在定义病例似然的组件时，它将被包含。

图3显示了模型0（仅共享空间效应，左上）和模型1（共享和特定空间效应，左下）的后验均值估计，以及喉癌病例特定空间效应的后验均值估计（右下）。

![图3](extracted/6292539/Plots/S0_M0.png)

**图3**：模型0（仅共享空间效应，左上）和模型1（共享和特定空间效应，左下）的后验均值估计，以及喉癌病例特定空间效应的后验均值估计（右下）。

从图中可以看出，共享空间效应存在很大的异质性，这可能主要是由于人口的城市集中[21](#fn:21)。此外，与共享空间随机效应的规模相比，病例特定空间随机效应的规模非常小。这表明病例和对照之间具有相似的空间模式，这主要由共享空间效应捕获。此外，两个模型中共享空间随机效应的估计值非常相似。这也表明病例和对照之间具有非常相似的空间模式，因为包含病例特定空间随机效应并没有改变第二个模型中的共享效应。

### 4.3 暴露于污染源

Chorley-Ribble数据集还包含一个废弃焚化炉的位置，该位置可能会影响病例的出现。因此，至少需要考虑焚化炉对病例强度分布的影响。因此，按照第2.4节[2.4 Analysis of the effect of risk factors](https://arxiv.org/html/2503.14954v1#S2.SS4 "2.4 Analysis of the effect of risk factors ‚Ä£ 2 Multivariate point pattern analysis ‚Ä£ Bayesian inference for case-control point pattern data in spatial epidemiology with the inlabru R package")中讨论的方法，考虑了三种不同的替代方法来建模焚化炉对病例分布的影响。

一个简单的选择是计算焚化炉位置与每个病例位置之间的距离，并将其作为典型的线性项包含在模型中。这将通过设置`model = "linear"`在组件中指定。

注意，组件`dist`的第一个参数定义为`dist_terra`。这是一个快捷方式，用于传递栅格格式的空间协变量，以便inlabru自动根据任何给定点的坐标获取协变量的正确值。这简化了代码，避免了用户自己计算这些值。

接下来，定义两个似然如下：

```{r}
# 对照组（肺癌）的似然
con.lik <- like(
  family = "cp",
  formula = geometry ~ Inter.con + sharedspde,
  samplers = bdy_sf,
  data = sl.lun,
  domain = list(geometry = mesh)
)

# 病例组（喉癌）的似然
lar.lik <- like(
  family = "cp",
  formula = geometry ~ Inter.lar + sharedspde + dist(dist_terra, model = "linear"),
  samplers = bdy_sf,
  data = sl.lar,
  domain = list(geometry = mesh)
)
```

除了考虑距离焚化炉的线性项外，还可以基于距离包含其他非线性平滑项，使用一维SPDE或一维高斯过程（也可以使用SPDE方法进行估计）。接下来，将考虑一阶高斯过程和二阶随机游走。

在这两种情况下，定义一维高斯过程需要一个一维网格，可以使用`fm_mesh_1d()`函数创建，如下所示：

```{r}
# 构建一维网格以用于暴露效应
mesh_cov <- fm_mesh_1d(
  seq(0, ceiling(minmax(dist_terra, TRUE)[2]), length = 20),
  degree = 2,
  boundary = c("free", "free")
)
```

然后，将此网格传递给`inla.spde2.matern()`函数，以定义SPDE随机效应，用于定义模型中的一个组件，如下所示：

```{r}
# 创建一维协变量SPDE效应的基函数
spde_cov <- inla.spde2.pcmatern(
  mesh = mesh_cov,
  alpha = 2,
  constr = TRUE,
  prior.range = c(10 / 5, 0.99),
  prior.sigma = c(1, 0.01)
)
```

注意，这里将先验设置为使范围小于空间SPDE随机效应的范围，以假设效应是局部化的，并且标准差设置得略大一些，以允许更大的局部变化。

最后，可以通过将范围设置为较大的固定值来近似二阶随机游走，如[20](#fn:20)中的结果所示。在下面的代码中，先验的第二个参数设置为`NA`，使其固定为第一个参数的值（10，在我们的例子中）。

```{r}
spde_cov <- inla.spde2.pcmatern(mesh = mesh_cov,
  alpha = 2,
  constr = TRUE,
  prior.range = c(10, NA),
  prior.sigma = c(1, 0.01)
)
```

注意，在两个模型中都添加了总和为零的约束。这是为了帮助识别这些暴露效应，因为可能存在与空间效应的混杂。

如上所述，当暴露效应被视为典型的线性效应时，`model`参数的值为"linear"。然而，当效应被明确定义时，保存效应的对象必须分配给`model`参数。在我们的例子中，我们将效应的定义保存在`spde_cov`中，因此我们指定了`model = spde_cov`。

无论随机效应的结构如何，通过在定义组件时设置`model`参数，将该效应引入线性预测器。然后，可以将此组件定义传递给定义不同似然和拟合所需模型的函数。图4显示了根据距离焚化炉的距离估计的喉癌病例强度的影响。

[21](#fn:21)报告说，在焚化炉附近病例显著增加。然而，他也提到这是由于一个小的病例集群中的四个病例。这种效应在图4（右）中线性模型的系数的负趋势中被清楚地捕捉到，以及在随机游走平滑项（图4，右下）中显示的非线性效应中。SPDE模型似乎没有如此清楚地捕捉到这种效应。[21](#fn:21)还通过从这个小的病例集群中移除一个或两个病例进行了敏感性分析，这导致了关联证据的减少。我们的结果通过宽的置信区间显示了对这种效应的高度不确定性。注意，在大多数空间流行病学研究中，增加样本量以减少不确定性不是一个选项。此外，还包括了一个简短的模拟研究，以评估所有三种提出的效应是否能有效地增加污染源周围的发病率。

![图4](extracted/6292539/Plots/Spcov_LinEff.png)

**图4**：根据距离焚化炉的距离（左）和根据距离源的距离（右）估计的焚化炉对喉癌病例强度的影响，对于线性效应（上）、一维SPDE（中）和二阶随机游走（下）。

不同模型的计算时间从24.71秒（喉癌病例的单变量模型）到3.01分钟（具有共享和特定组成部分且没有协变量的多变量模型）不等。这些时间代表了执行整个脚本（包括数据加载、处理和结果可视化）所需的时间。脚本在运行Windows 10 LTSC Enterprise（1809）操作系统的计算机上运行，该计算机配备了12代Intel(R) Core(TM) i7-12700K处理器，主频为3.61GHz，内存为32GB。

## 5 讨论

空间流行病学中点模式的分析通常需要研究空间风险的变化以及评估潜在风险因素。特别是，评估潜在污染源附近的增加风险是一个主要关注点。在本文中，我们展示了如何广泛采用对数高斯考克斯过程来解决估计空间风险变化和评估空间及非空间风险因素效应的问题。此外，使用集成嵌套拉普拉斯近似进行了关于所需模型的贝叶斯推断。这允许基于Matérn协方差的高斯过程估计空间随机效应，可以通过基于随机偏微分方程的近似有效地估计。此外，还提出并讨论了一些指导方针，以便为（Matérn协方差函数）空间效应的超参数选择适当的先验分布。

使用一个著名的病例对照数据集展示了所提出方法的使用，并逐步解释了进行分析的程序。为此，使用了inlabru R包，因为它提供了一种简单的方法来定义和拟合所需的模型。我们的分析考虑了本文中的不同模型，结果与当前文献一致。可以在https://github.com/FranciscoPalmiPerales/MVPP-inlabru找到用于完整分析的数据集的R代码，以便重现。

总之，本文介绍了一个易于访问、用户友好且高效的工具箱，用于在流行病学背景下分析多变量点模式，无需统计或编程专业知识。特别是，inlabru R包为流行病学家提供了一个简单且易于接近的框架，用于分析多变量点模式数据。